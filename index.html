<!DOCTYPE html>
<html>

<head>
	<title>RawCat</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
	<link rel="stylesheet" href="http://www.jacklmoore.com/colorbox/example1/colorbox.css" />
	<style type="text/css">
		html,
		body,
		#map {
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
		}

		.leaflet-popup-content {
			overflow: hidden;
		}

		.leaflet-popup-content #infopic {
			float: right;
		}

		.leaflet-popup-content #infotext {
			float: left;
		}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
	<script src="http://rawgithub.com/shramov/leaflet-plugins/master/layer/Marker.Rotate.js"></script>
	<script src="http://rawgithub.com/mlevans/leaflet-hash/master/leaflet-hash.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.3/jquery.min.js"></script>
	<script src="http://www.jacklmoore.com/colorbox/jquery.colorbox.js"></script>
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div id="map"></div>
	<!-- <button class="button" style="color: #2196F3;" id="refreshButton">Refresh Button</button> -->
	<div class="leafletButton">
		<label class="container">Follow
			<input type="checkbox" checked="checked" id="follow">
			<span class="checkmark"></span>
		</label>
		<!-- <button class="button" style="background-color: #2196F3; color:whitesmoke" id="refreshButton"
			onclick="flyToRoute()">Fit to Route</button> -->
	</div>
	<script src="geojson.js" type="text/javascript"></script>
	<script type="text/javascript">

		//<![CDATA[
		(function ($) {
			$(function () {

				var map = new L.Map('map').setView([58.198395, 11.466894], 16);

				map.attributionControl.setPrefix('').addAttribution('Map data &copy; <a href="http://www.marinetraffic.com">MarineTraffic</a>');

				var hash = new L.Hash(map);

				var positron = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
					subdomains: 'abcd',
					maxZoom: 19
				})

				// https://map02.eniro.no/geowebcache/service/tms1.0.0/nautical2x/15/17458/22843.png?c=3854509113&v=20200602
				var nautical = L.tileLayer("https://map02.eniro.no/geowebcache/service/tms1.0.0/nautical2x/{z}/{x}/{y}.{type}?c=crc&v={tileVersion}", {
					attribution: "",
					errorTileUrl: "",
					layer: "nautical2x",
					maxZoom: 17,
					minZoom: 3,
					noWrap: true,
					opacity: 1,
					reuseTiles: false,
					subdomains: ["map01", "map02", "map03", "map04"],
					tileSize: 256,
					tileVersion: "20200602",
					tms: true,
					type: "png",
					unloadInvisibleTiles: false,
					updateWhenIdle: false,
					zIndex: 0,
					zoomOffset: 0
				}).addTo(map);

				openseamap = new L.TileLayer('http://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

				var latlngs = [
					[0, 0],
					[0, 0]
				];

				var route = L.polyline(latlngs, {
					color: '#214F5D',
					weight: 5,
					opacity: 0.8
				}).addTo(map);

				route.on('click', function (e) {
					$.colorbox({
						href: "route.html",
						iframe: true,
						width: '80%',
						height: '80%'
					});
				});

				var xhttpRoute = new XMLHttpRequest();
				xhttpRoute.onreadystatechange = function () {
					var obj = JSON.parse(this.responseText)
					var array = []
					obj.geometry.coordinates.forEach(function (coordinate) {
						array.push([coordinate[1], coordinate[0]]);
					});
					route.setLatLngs(array)
				};
				xhttpRoute.open("GET", "http://127.0.0.1:5000/route", true);
				xhttpRoute.send();

				var layersControl = new L.Control.Layers({
					'Positron': positron,
					'Nautical': nautical
				}, {
					'OpenSeaMap': openseamap,
					'Route': route
				}).addTo(map);

				var boatIcon = new L.Icon({
					iconUrl: 'marker.png',
					shadowUrl: null,
					iconSize: new L.Point(19, 26),
					iconAnchor: new L.Point(9, 13)
				});

				var boat = L.marker([0, 0], { icon: boatIcon }).addTo(map);
				boat.on('click', function (e) {
					$.colorbox({
						href: "boat.html",
						iframe: true,
						width: '80%',
						height: '80%'
					});
				});

				var polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);

				function loadBoat() {
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function () {
						obj = JSON.parse(this.responseText);
						console.log(obj)
						boat.setLatLng([obj.latitude, obj.longitude])
						boat.setIconAngle(obj.course)

						latlngs = [
							[obj.latitude, obj.longitude],
							[obj.goallatitude, obj.goallongitude]
						];
						polyline.setLatLngs(latlngs)

						var follow = document.getElementById("follow");
						if(follow.checked == true){
							console.log("fly")
							map.flyTo(boat.getLatLng())
						}
					};
					xhttp.open("GET", "http://127.0.0.1:5000/routeInfo", true);
					xhttp.send();
				}
				loadBoat();
				var myVar = setInterval(loadBoat, 1000);

				function flyToRoute(){
					map.flyToBounds(route.getBounds())
				};
			});
		})(jQuery);
//]]>
	</script>
</body>

</html>