<!DOCTYPE html>
<html>

<head>
	<title>RawCat</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
	<link rel="stylesheet" href="http://www.jacklmoore.com/colorbox/example1/colorbox.css" />
	<style type="text/css">
		html,
		body,
		#map {
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
		}

		.leaflet-popup-content {
			overflow: hidden;
		}

		.leaflet-popup-content #infopic {
			float: right;
		}

		.leaflet-popup-content #infotext {
			float: left;
		}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
	<script src="http://rawgithub.com/shramov/leaflet-plugins/master/layer/Marker.Rotate.js"></script>
	<script src="http://rawgithub.com/mlevans/leaflet-hash/master/leaflet-hash.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.3/jquery.min.js"></script>
	<script src="http://www.jacklmoore.com/colorbox/jquery.colorbox.js"></script>
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<script src="ip.js" type="text/javascript"></script>
	<div id="map"></div>
	<script type="text/javascript">

		//<![CDATA[
		(function ($) {
			$(function () {
				var follow = true;
				var darkmode = true;
				var map = new L.Map('map').setView([58.198395, 11.466894], 16);

				map.attributionControl.setPrefix('').addAttribution('Map data &copy; <a href="http://www.marinetraffic.com">MarineTraffic</a>');

				var hash = new L.Hash(map);

				var positron = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
					subdomains: 'abcd',
					maxZoom: 19
				}).addTo(map);

				// https://map02.eniro.no/geowebcache/service/tms1.0.0/nautical2x/15/17458/22843.png?c=3854509113&v=20200602
				var nautical = L.tileLayer("https://map02.eniro.no/geowebcache/service/tms1.0.0/nautical2x/{z}/{x}/{y}.{type}?c=crc&v={tileVersion}", {
					attribution: "",
					errorTileUrl: "",
					layer: "nautical2x",
					maxZoom: 17,
					minZoom: 3,
					noWrap: true,
					opacity: 1,
					reuseTiles: false,
					subdomains: ["map01", "map02", "map03", "map04"],
					tileSize: 256,
					tileVersion: "20200602",
					tms: true,
					type: "png",
					unloadInvisibleTiles: false,
					updateWhenIdle: false,
					zIndex: 0,
					zoomOffset: 0
				})

				openseamap = new L.TileLayer('http://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

				var followControl = L.Control.extend({

					options: {
						position: 'bottomright'
					},

					onAdd: function (map) {
						var container = L.DomUtil.create('p');
						container.type = "button";
						container.title = "Follow RawCat";

						container.style.backgroundColor = 'transparent';
						container.style.backgroundImage = "url(images/follow.png)";
						container.style.backgroundSize = "30px 30px";
						container.style.width = '30px';
						container.style.height = '30px';
						container.onclick = function () {
							follow = !follow
							if (follow) {
								container.style.backgroundImage = "url(images/follow.png)";
							}
							else {
								container.style.backgroundImage = "url(images/notfollow.png)";
							}
						}
						return container;
					}
				});

				var seeRouteControl = L.Control.extend({

					options: {
						position: 'bottomright'
					},

					onAdd: function (map) {
						var container = L.DomUtil.create('p');
						container.type = "button";
						container.title = "Go to route RawCat";

						container.style.backgroundColor = 'transparent';
						container.style.backgroundImage = "url(images/route.png)";
						container.style.backgroundSize = "30px 30px";
						container.style.width = '30px';
						container.style.height = '30px';
						container.onclick = function () {
							map.flyToBounds(route.getBounds())

						}
						return container;
					}
				});

				// var offon = L.Control.extend({

				// 	options: {
				// 		position: 'bottomleft'
				// 	},

				// 	onAdd: function (map) {
				// 		var container = L.DomUtil.create('p');
				// 		container.type = "button";
				// 		container.title = "off/on";

				// 		container.style.backgroundColor = 'transparent';
				// 		container.style.backgroundImage = "url(images/off.png)";
				// 		container.style.backgroundSize = "30px 30px";
				// 		container.style.width = '30px';
				// 		container.style.height = '30px';
				// 		container.onclick = function () {

				// 			var xhttpOnOff = new XMLHttpRequest();
				// 			xhttpOnOff.onreadystatechange = function () {
				// 				var obj = JSON.parse(this.responseText)
				// 				darkmode = obj.;
				// 				if (darkmode) {
				// 					container.style.backgroundImage = "url(images/off.png)";
				// 				}
				// 				else {
				// 					container.style.backgroundImage = "url(images/on.png)";
				// 				}
				// 			};
				// 			xhttpOnOff.open("GET", ip + "/data", true);
				// 			xhttpOnOff.send();


				// 		}
				// 		return container;
				// 	}
				// });

				var latlngs = [
					[58.198395, 11.466894],
					[58.198395, 11.466894]
				];

				var route = L.polyline(latlngs, {
					color: '#214F5D',
					weight: 5,
					opacity: 0.8
				}).addTo(map);

				route.on('click', function (e) {
					$.colorbox({
						href: "route.html",
						iframe: true,
						width: '80%',
						height: '80%'
					});
				});

				var xhttpRoute = new XMLHttpRequest();
				xhttpRoute.onreadystatechange = function () {
					var obj = JSON.parse(this.responseText)
					var array = []
					obj.geometry.coordinates.forEach(function (coordinate) {
						array.push([coordinate[1], coordinate[0]]);
					});
					route.setLatLngs(array)
				};
				xhttpRoute.open("GET", ip + "/route", true);
				xhttpRoute.send();


				var boatIcon = new L.Icon({
					iconUrl: 'images/marker.png',
					shadowUrl: null,
					iconSize: new L.Point(19, 26),
					iconAnchor: new L.Point(9, 13)
				});

				var boat = L.marker([0, 0], { icon: boatIcon }).addTo(map);
				boat.on('click', function (e) {
					$.colorbox({
						href: "boat.html",
						iframe: true,
						width: '80%',
						height: '80%'
					});
				});

				var goalDirection = L.polyline(latlngs, {
					color: 'red',
					weight: 5,
					opacity: 0.4
				});

				var layersControl = new L.Control.Layers({
					'Positron': positron,
					'Nautical': nautical
				}, {
					'OpenSeaMap': openseamap,
					'Route': route,
					"Goal direction": goalDirection
				}).addTo(map);
				map.addControl(new followControl());
				map.addControl(new seeRouteControl());
				map.addControl(new offon());

				function loadBoat() {
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function () {
						obj = JSON.parse(this.responseText);
						console.log(obj)
						boat.setLatLng([obj.latitude, obj.longitude])
						boat.setIconAngle(obj.course)

						latlngs = [
							[obj.latitude, obj.longitude],
							[obj.goallatitude, obj.goallongitude]
						];
						goalDirection.setLatLngs(latlngs)

						// var follow = document.getElementById("follow");
						if (follow) {
							console.log("fly")
							map.flyTo(boat.getLatLng())
						}
					};
					xhttp.open("GET", ip + "/routeInfo", true);
					xhttp.send();
				}
				loadBoat();
				var myVar = setInterval(loadBoat, 1000);

			});
		})(jQuery);
//]]>
	</script>
</body>

</html>